<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>表结构文档生成工具</title>
    <script src="/js/vue.js"></script>
    <link rel="icon" type="image/x-icon" href="/icon/favicon.ico">
    <!-- 引入样式 -->
    <link rel="stylesheet" href="/css/element.css">
    <link rel="stylesheet" href="/css/normalize.css">
    <!-- 引入组件库 -->
    <script src="/js/element.js"></script>

    <script src="/js/axios.min.js"></script>

    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<div id="app">
    <el-container v-loading="loading"
                  element-loading-text="正在加载中..."
                  element-loading-spinner="el-icon-loading"
                  element-loading-background="rgba(0, 0, 0, 0.8)">
        <el-aside width="270px" id="aside">
            <div class="title">表结构文档生成工具</div>
            <el-tree
                    style="margin: 10px"
                    ref="structureTree"
                    :load="loadNode"
                    @check-change="selectNode"
                    lazy
                    show-checkbox
                    node-key="nodeId"
                    :props="defaultProps">
            </el-tree>
        </el-aside>
        <el-container id="container">
            <div id="context">
                <div id="dragHandle"></div>
                <el-main>
                    <el-card class="box-card">
                        <div class="action-items">
                            <el-button @click="dialogVisible = true" type="text">选择列名</el-button>
                            <el-button @click="preview" type="text">预览文档</el-button>
                            <el-button @click="downloadWord" type="text">下载word文档</el-button>
                            <el-button @click="downloadPdf" type="text">下载pdf文档</el-button>
                            <el-button @click="downloadMarkdown" type="text">下载markdown文档</el-button>
                            <el-button @click="downloadHtml" type="text">下载HTML文档</el-button>

                        </div>
                        <iframe id="iframe" :src="pdf"></iframe>
                        <div id="overIframeDiv"></div>
                    </el-card>
                </el-main>
            </div>
        </el-container>
    </el-container>
    <el-dialog
            :lock-scroll="false"
            title="选择列名"
            :visible.sync="dialogVisible"
            width="550px">
        <el-checkbox-group v-model="defaultColumns">
            <el-checkbox class="checkbox" :key="item.value" v-for="item of allColumns" :label="item.value">
                {{item.label}}
            </el-checkbox>
        </el-checkbox-group>
        <span slot="footer" class="dialog-footer">
    <el-button size="small" @click="dialogVisible = false">取 消</el-button>
    <el-button size="small" type="primary" @click="dialogVisible = false">确 定</el-button>
  </span>
    </el-dialog>
</div>
<script>
    // 创建一个新的 Vue 实例
    new Vue({
        el: '#app',
        data: {
            data: [],
            loading: false,
            dialogVisible: false,
            allColumns: [],
            defaultColumns: [],
            defaultProps: {
                children: 'children',
                label: 'labelName'
            },
            pdf: ''
        },
        methods: {
            async selectNode(data, selected) {
                let structureTree = this.$refs.structureTree;
                let node = structureTree.getNode(data)
                if (selected && data.childrenCount !== 0 && node.level === 1) {
                    let tables = await this.getTables(data)
                    // 新增子节点
                    structureTree.updateKeyChildren(data.nodeId, tables)
                    this.$nextTick(() => {
                        for (let table of tables) {
                            structureTree.setChecked(table, true)
                            structureTree.getNode(table).isLeaf = true
                        }
                    })
                } else if (!selected && node.level === 2) {
                    structureTree.setChecked(data, false)
                } else if (!selected && node.level === 1 && !structureTree.getHalfCheckedKeys().includes(data.nodeId)) {
                    structureTree.setChecked(data, false)
                    for (let childNode of node.childNodes) {
                        structureTree.setChecked(childNode.data, false)
                    }
                }
            },
            async loadNode(node, resolve) {
                try {
                    this.loading = true;
                    if (node.level === 0) {
                        let databases = await this.getDatabases();
                        resolve(databases);
                        this.$nextTick(() => {
                            let structureTree = this.$refs.structureTree;
                            for (let database of databases) {
                                database.childrenCount === 0 && (structureTree.getNode(database).isLeaf = true)
                            }
                        })
                    } else if (node.level === 1) {
                        let tables = await this.getTables(node.data);
                        resolve(tables);
                        this.$nextTick(() => {
                            let structureTree = this.$refs.structureTree;
                            for (let table of tables) {
                                structureTree.getNode(table).isLeaf = true
                            }
                        })
                    }
                } catch (err) {
                    this.showMessage('error', err)
                    resolve([])
                } finally {
                    this.loading = false;
                }
            },
            getDatabases() {
                return new Promise((resolve, reject) => {
                    axios.get('/document/getDatabases').then(res => {
                        if (res.data.code === 200) {
                            resolve(res.data.data);
                        } else {
                            reject("数据加载失败");
                        }
                    }).catch(err => {
                        reject(err);
                    });
                });
            },
            getTables(data) {
                let schemaName = data.labelName;
                let parentNodeId = data.nodeId;
                return new Promise((resolve, reject) => {
                    axios.get('/document/getTables', {params: {parentNodeId, schemaName}}).then(res => {
                        if (res.data.code === 200) {
                            resolve(res.data.data);
                        } else {
                            reject("数据加载失败");
                        }
                    }).catch(err => {
                        reject(err);
                    });
                });
            },
            getTableColumns() {
                axios.get('/document/getTableColumnInfo').then(res => {
                    if (res.data.code === 200) {
                        this.allColumns = res.data.data.allColumns;
                        this.defaultColumns = res.data.data.defaultColumns;
                    } else {
                        this.showMessage("error", "数据加载失败!")
                    }
                }).catch(err => {
                    this.showMessage("error", "数据加载失败!")
                })
            },
            preview() {
                if (this.getCheckedNodes().length === 0) {
                    this.showMessage("error", "当前未选中任何数据表!")
                    return;
                }
                this.loading = true
                axios({
                    method: 'post',
                    url: '/document/pdf/preview',
                    responseType: 'arraybuffer', // 指定响应类型为二进制流
                    data: {dataList: this.getCheckedNodes(), defaultColumns: this.defaultColumns}
                }).then(res => {
                    if (res.status === 200) {
                        const blob = new Blob([res.data], {type: "application/pdf"});
                        this.pdf = URL.createObjectURL(blob);
                    } else {
                        this.showMessage("error", "预览失败!")
                    }
                    this.loading = false
                }).catch(err => {
                    this.showMessage("error", err.message)
                    this.loading = false
                });
            },
            downloadWord() {
                if (this.getCheckedNodes().length === 0) {
                    this.showMessage("error", "当前未选中任何数据表")
                    return;
                }
                this.loading = true
                axios({
                    method: 'post',
                    url: '/document/word/download',
                    responseType: 'blob', // 指定响应类型为二进制流
                    data: {
                        dataList: this.getCheckedNodes(),
                        contentType: this.contentType,
                        defaultColumns: this.defaultColumns
                    }
                }).then(res => {
                    if (res.status === 200) {
                        let blob = new Blob([res.data])
                        let url = window.URL.createObjectURL(blob)
                        let downloadElement = document.createElement('a')
                        downloadElement.style.display = 'none'
                        downloadElement.href = url
                        downloadElement.setAttribute('download', decodeURIComponent(res.headers['filename']))
                        document.body.appendChild(downloadElement)
                        downloadElement.click()
                        document.body.removeChild(downloadElement) // 下载完成移除元素
                        window.URL.revokeObjectURL(url) // 释放掉blob对象
                        this.showMessage("success", "下载成功!")
                    } else {
                        this.showMessage("error", "下载失败!")
                    }
                    this.loading = false
                }).catch(err => {
                    this.showMessage("error", err.message)
                    this.loading = false
                });
            },
            downloadPdf() {
                if (this.getCheckedNodes().length === 0) {
                    this.showMessage("error", "当前未选中任何数据表!")
                    return;
                }
                this.loading = true
                axios({
                    method: 'post',
                    url: '/document/pdf/download',
                    responseType: 'blob', // 指定响应类型为二进制流
                    data: {
                        dataList: this.getCheckedNodes(),
                        contentType: this.contentType,
                        defaultColumns: this.defaultColumns
                    }
                }).then(res => {
                    if (res.status === 200) {
                        let blob = new Blob([res.data])
                        let url = window.URL.createObjectURL(blob)
                        let downloadElement = document.createElement('a')
                        downloadElement.style.display = 'none'
                        downloadElement.href = url
                        downloadElement.setAttribute('download', decodeURIComponent(res.headers['filename']))
                        document.body.appendChild(downloadElement)
                        downloadElement.click()
                        document.body.removeChild(downloadElement) // 下载完成移除元素
                        window.URL.revokeObjectURL(url) // 释放掉blob对象
                        this.showMessage("success", "下载成功!")
                    } else {
                        this.showMessage("error", "下载失败!")
                    }
                    this.loading = false
                }).catch(err => {
                    this.showMessage("error", err.message)
                    this.loading = false
                });
            },
            downloadMarkdown() {
                if (this.getCheckedNodes().length === 0) {
                    this.showMessage("error", "当前未选中任何数据表!")
                    return;
                }
                this.loading = true
                axios({
                    method: 'post',
                    url: '/document/markdown/download',
                    responseType: 'blob', // 指定响应类型为二进制流
                    data: {
                        dataList: this.getCheckedNodes(),
                        contentType: this.contentType,
                        defaultColumns: this.defaultColumns
                    }
                }).then(res => {
                    if (res.status === 200) {
                        let blob = new Blob([res.data])
                        let url = window.URL.createObjectURL(blob)
                        let downloadElement = document.createElement('a')
                        downloadElement.style.display = 'none'
                        downloadElement.href = url
                        downloadElement.setAttribute('download', decodeURIComponent(res.headers['filename']))
                        document.body.appendChild(downloadElement)
                        downloadElement.click()
                        document.body.removeChild(downloadElement) // 下载完成移除元素
                        window.URL.revokeObjectURL(url) // 释放掉blob对象
                        this.showMessage("success", "下载成功!")
                    } else {
                        this.showMessage("error", "下载失败!")
                    }
                    this.loading = false
                }).catch(err => {
                    this.showMessage("error", err.message)
                    this.loading = false
                });
            },
            downloadHtml() {
                if (this.getCheckedNodes().length === 0) {
                    this.showMessage("error", "当前未选中任何数据表!")
                    return;
                }
                this.loading = true
                axios({
                    method: 'post',
                    url: '/document/html/download',
                    responseType: 'blob', // 指定响应类型为二进制流
                    data: {
                        dataList: this.getCheckedNodes(),
                        contentType: this.contentType,
                        defaultColumns: this.defaultColumns
                    }
                }).then(res => {
                    if (res.status === 200) {
                        let blob = new Blob([res.data])
                        let url = window.URL.createObjectURL(blob)
                        let downloadElement = document.createElement('a')
                        downloadElement.style.display = 'none'
                        downloadElement.href = url
                        downloadElement.setAttribute('download', decodeURIComponent(res.headers['filename']))
                        document.body.appendChild(downloadElement)
                        downloadElement.click()
                        document.body.removeChild(downloadElement) // 下载完成移除元素
                        window.URL.revokeObjectURL(url) // 释放掉blob对象
                        this.showMessage("success", "下载成功!")
                    } else {
                        this.showMessage("error", "下载失败!")
                    }
                    this.loading = false
                }).catch(err => {
                    this.showMessage("error", err.message)
                    this.loading = false
                });
            },
            getCheckedNodes() {
                let tree = this.$refs.structureTree;
                let checkedNodes = tree.getCheckedNodes();
                let parentNodeIds = new Set(checkedNodes.filter(node => node.parentNodeId != null).map(node => node.parentNodeId));
                for (let parentNodeId of parentNodeIds) {
                    let node = tree.getNode(parentNodeId).data;
                    if (!checkedNodes.includes(node)) {
                        checkedNodes.push(node)
                    }
                }
                return checkedNodes;
            },
            showMessage(type, message) {
                this.$message({
                    message: message,
                    type: type,
                });
            },
            initChangeBoxWidthEvent() {
                let dragHandle = document.getElementById("dragHandle");
                let startX, startWidth;
                dragHandle.addEventListener("mousedown", function (e) {
                    startX = e.clientX;
                    startWidth = parseInt(document.defaultView.getComputedStyle(document.getElementById("context")).width, 10);
                    document.addEventListener("mousemove", doDrag, false);
                    document.addEventListener("mouseup", stopDrag, false);
                }, false);

                function doDrag(e) {
                    let reduceWidth = e.clientX - startX;
                    let newWidth = startWidth - reduceWidth;
                    if (newWidth > 0) {
                        let container = document.getElementById("context");
                        let aside = document.getElementById("aside");
                        container.style.left = (container.style.left + reduceWidth) + 'px';
                        container.style.width = newWidth + "px";
                        aside.style.width = e.clientX + 'px'
                    }
                }

                function stopDrag() {
                    document.removeEventListener("mousemove", doDrag, false);
                    document.removeEventListener("mouseup", stopDrag, false);
                }
            },
        },
        mounted: function () {
            this.getTableColumns();
            this.initChangeBoxWidthEvent()
        }
    });
</script>
</body>
</html>